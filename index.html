<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simple Weekly Timetable</title>
  <style>
    :root{--bg:#0b0d12;--ink:#e6edf3;--muted:#9aa4b2;--line:#1e2738;--card:#121621;--now:#ff4d4d;--next:#ffd34d}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{padding:12px 16px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:16px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select,button{background:var(--card);border:1px solid var(--line);color:var(--ink);border-radius:8px;padding:6px 10px;cursor:pointer}
    .wrap{max-width:1280px;margin:0 auto;padding:16px}
    .weekline{margin:0 0 10px 0;color:var(--muted)}
    .cols{display:grid;grid-template-columns:repeat(5,minmax(240px,1fr));gap:16px}
    .col{border:1px solid var(--line);border-radius:10px;padding:10px;position:relative}
    .day{font-weight:700;font-size:14px;margin-bottom:6px;display:flex;align-items:center;gap:6px}
    .todaydot{width:6px;height:6px;background:var(--now);border-radius:999px;display:inline-block}
    .item{border:1px solid var(--line);border-radius:10px;padding:8px 10px;margin-bottom:10px;background:#0f1320}
    .item.now{border-color:var(--now);box-shadow:0 0 0 1px var(--now) inset}
    .item.next{border-color:#6b5d1a;box-shadow:0 0 0 1px #6b5d1a inset}
    .badge{display:inline-block;font-size:11px;padding:2px 6px;border-radius:999px;margin-left:6px}
    .badge.now{background:var(--now);color:#1a0b0b}
    .badge.next{background:var(--next);color:#1a1a00}
    .muted{color:var(--muted);font-size:12px}
    .cc{font-weight:700}
    .nowsep{height:2px;background:var(--now);border-radius:2px;margin:6px 0}
    .wklec{font-weight:800;font-size:15px;margin-top:6px;color:#dce3f1}
    .statusbar{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:20px 24px;margin:20px 0;color:var(--ink);box-shadow:0 2px 8px rgba(0,0,0,0.25);font-size:20px;font-weight:700}
    @media (max-width: 720px){.cols{grid-template-columns:1fr}.col{display:none}.col.mobile-current{display:block}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body>
  <header>
    <h1>Simple Weekly Timetable</h1>
    <div class="controls">
      <button id="prev">◀</button>
      <select id="week"></select>
      <button id="next">▶</button>
      <button id="currentWeek">Current Week</button>
      <label style="display:flex;align-items:center;gap:6px;margin-left:8px;font-size:12px;color:var(--muted)"><input id="override" type="checkbox"/> Override</label>
    </div>
  </header>

  <div class="wrap">
    <div class="statusbar" id="statusBar">—</div>
    <p class="weekline" id="wkInfo"></p>
    <div class="cols" id="cols"></div>
    <div class="statusbar" id="footerBar">Loading…</div>
  </div>

  <script>
  const WEEK2_MON=new Date(2025,9,6);const WEEKS=Array.from({length:11},(_,i)=>i+2);
  const pad2=n=>n.toString().padStart(2,'0');const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x;};const stripTime=d=>new Date(d.getFullYear(),d.getMonth(),d.getDate()).getTime();const weekStart=w=>addDays(WEEK2_MON,(w-2)*7);const weekOf=d=>2+Math.floor((stripTime(d)-stripTime(WEEK2_MON))/(7*24*3600*1000));const daysMap={monday:1,tuesday:2,wednesday:3,thursday:4,friday:5};
  let TEMPLATE=[];let DATA=[];const STORAGE_KEY='attendance_v1';const attMap=new Map();const getKey=(code,start)=>`${code}|${start.toISOString()}`;const saveLocal=()=>{try{localStorage.setItem(STORAGE_KEY,JSON.stringify(Object.fromEntries(attMap)));}catch(_){}};const loadLocal=()=>{try{const raw=localStorage.getItem(STORAGE_KEY);if(raw){const obj=JSON.parse(raw);Object.entries(obj).forEach(([k,v])=>attMap.set(k,v));}}catch(_){}};
  const ATTENDANCE={endpoint:"https://docs.google.com/forms/d/e/1FAIpQLSfvyGOa1oTO7IMoCwS7u0JglKPm_Cb7dMCkxlXM77F9NCNHXQ/formResponse",fields:{course:"entry.681754580",when:"entry.1108216594",status:"entry.806602048"}};
  function toast(msg){const t=document.createElement('div');t.textContent=msg;Object.assign(t.style,{position:'fixed',bottom:'20px',left:'50%',transform:'translateX(-50%)',background:'#121621',border:'1px solid #1e2738',color:'#e6edf3',padding:'10px 14px',borderRadius:'10px',boxShadow:'0 2px 8px rgba(0,0,0,.25)',zIndex:9999});document.body.appendChild(t);setTimeout(()=>t.remove(),1500);}
  function logAttendance({code,start,status}){const form=new FormData();form.set(ATTENDANCE.fields.course,code);form.set(ATTENDANCE.fields.when,start.toISOString());form.set(ATTENDANCE.fields.status,status);fetch(ATTENDANCE.endpoint,{method:'POST',mode:'no-cors',body:form}).catch(()=>{});attMap.set(getKey(code,start),status);saveLocal();toast('Attendance logged');render();}
  async function loadYAML(){try{const res=await fetch('classes.yaml',{cache:'no-store'});const text=await res.text();const raw=jsyaml.load(text);TEMPLATE=raw.map(e=>({...e,day:daysMap[e.day.toLowerCase()]||1}));buildSchedule();loadLocal();render();updateStatus();setInterval(()=>{render();updateStatus();},60000);document.getElementById('footerBar').textContent='Loaded ✓';}catch(err){console.error(err);document.getElementById('footerBar').textContent='Could not load classes.yaml';}}
  function buildSchedule(){DATA=[];for(const w of WEEKS){const mon=weekStart(w);for(const t of TEMPLATE){const dd=addDays(mon,t.day-1);const s=new Date(dd.getFullYear(),dd.getMonth(),dd.getDate(),+t.start.slice(0,2),+t.start.slice(3));const e=new Date(dd.getFullYear(),dd.getMonth(),dd.getDate(),+t.end.slice(0,2),+t.end.slice(3));DATA.push({...t,start:s,end:e,week:w});}}}
  function cumulativeLectureNumbers(upto){const list=DATA.filter(x=>x.week<=upto).sort((a,b)=>a.start-b.start);const count=new Map();const map=new WeakMap();for(const it of list){const n=(count.get(it.code)||0)+1;count.set(it.code,n);map.set(it,n);}return map;}
  function render(){const weekSel=document.getElementById('week');const week=+weekSel.value||weekOf(new Date());const mon=weekStart(week);const sun=addDays(mon,6);const now=new Date();const todayD=now.getDay();const isCurrentWeek=(week===weekOf(now));const override=document.getElementById('override').checked;document.getElementById('wkInfo').textContent=`Week ${week} (${mon.toLocaleDateString()} – ${sun.toLocaleDateString()})`;const cum=cumulativeLectureNumbers(week);const days=[1,2,3,4,5];const titles=['Mon','Tue','Wed','Thu','Fri'];const items=DATA.filter(x=>x.week===week).sort((a,b)=>a.start-b.start);const byDay=new Map(days.map(d=>[d,[]]));for(const it of items)byDay.get(it.day).push(it);const cols=document.getElementById('cols');cols.innerHTML=days.map((d,i)=>{const list=byDay.get(d);const isTodayCol=isCurrentWeek&&(new Date().getDay()===d);let pieces=[];let insertedSep=false;let markedNext=false;for(const it of list){const key=getKey(it.code,it.start);const status=attMap.get(key)||null;const ongoing=isTodayCol&&now>=it.start&&now<=it.end;const nextUp=isTodayCol&&!ongoing&&!markedNext&&now<it.start;if(nextUp)markedNext=true;const showButtons=(!status)||override;const buttonSection=showButtons?`<div style='margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;'><button onclick="logAttendance({code:'${it.code}',start:new Date(${it.start.getTime()}),status:'Present'})">Mark present</button><button onclick="logAttendance({code:'${it.code}',start:new Date(${it.start.getTime()}),status:'Absent'})">Mark absent</button></div>`:'';pieces.push(`<div class='item ${ongoing?"now":""} ${nextUp?"next":""}'><div class='cc'>${it.code} - ${it.name}${ongoing?" <span class='badge now'>NOW</span>":nextUp?" <span class='badge next'>NEXT</span>":""}</div><div class='muted'>Room: ${it.room}</div><div class='muted'>${pad2(it.start.getHours())}:${pad2(it.start.getMinutes())}–${pad2(it.end.getHours())}:${pad2(it.end.getMinutes())}</div><div class='wklec'>Week ${week} · Lecture ${cum.get(it)}</div><div>${status?`Attendance: ${status}`:'Attendance: Unmarked'}</div>${buttonSection}</div>`);}if(isTodayCol&&!insertedSep){pieces=(list.length&&now>list[list.length-1].end)?pieces.concat([`<div class='nowsep'></div>`]):[`<div class='nowsep'></div>`].concat(pieces);}const header=isTodayCol?`<span class='todaydot' title='Today'></span> ${titles[i]}`:titles[i];const inner=pieces.join('')||`<div class='muted'>No classes</div>`;return `<div class='col ${d===todayD?"mobile-current":""}'><div class='day'>${header}</div>${inner}</div>`;}).join('');}
  function formatDelta(ms){const m=Math.round(ms/60000);if(m<=0)return'now';if(m<60)return`${m} min${m===1?'':'s'}`;const h=Math.floor(m/60),r=m%60;return r?`${h}h ${r}m`:`${h}h`;}
  function updateStatus(){const now=new Date();const cum=cumulativeLectureNumbers(12);const ongoing=DATA.find(x=>now>=x.start&&now<=x.end);const bar=document.getElementById('statusBar');if(ongoing){const until=`${pad2(ongoing.end.getHours())}:${pad2(ongoing.end.getMinutes())}`;bar.textContent=`Now: ${ongoing.code} - ${ongoing.name} (until ${until}, Room ${ongoing.room}) (Lecture ${cum.get(ongoing)} Week ${ongoing.week})`;return;}const future=DATA.filter(x=>x.start>now).sort((a,b)=>a.start-b.start)[0];if(future){bar.textContent=`Next: ${future.code} - ${future.name} in ${formatDelta(future.start-now)} (Room ${future.room}) (Lecture ${cum.get(future)} Week ${future.week})`;}else{bar.textContent=`You're done — no upcoming classes in the timetable.`;}}
  const weekSel=document.getElementById('week');weekSel.innerHTML=WEEKS.map(w=>{const m=weekStart(w);const label=m.toLocaleDateString([], {month:'short',day:'numeric'});return `<option value='${w}'>Week ${w} — ${label}</option>`;}).join('');weekSel.value=weekOf(new Date());weekSel.addEventListener('change',render);document.getElementById('prev').addEventListener('click',()=>{const v=+weekSel.value;if(v>2){weekSel.value=v-1;render();}});document.getElementById('next').addEventListener('click',()=>{const v=+weekSel.value;if(v<12){weekSel.value=v+1;render();}});document.getElementById('currentWeek').addEventListener('click',()=>{const cw=weekOf(new Date());if(cw>=2&&cw<=12){weekSel.value=cw;render();}else{alert('Today is outside teaching weeks (2–12).');}});document.getElementById('override').addEventListener('change',render);
  loadYAML();
  </script>
</body>
</html>